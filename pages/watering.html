<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบรดน้ำ | สวนทุเรียน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
</head>
<body onload="guard(); renderZones(); renderQueue();">
<nav class="navbar navbar-dark bg-success">
  <div class="container-fluid">
    <a class="navbar-brand" href="dashboard.html">← แดชบอร์ด</a>
    <span class="navbar-text">ระบบรดน้ำ</span>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>โซนหลัก & จุดย่อย</h4>
    <button class="btn btn-success" onclick="addZone()"><i class="fa fa-plus"></i> เพิ่มโซน</button>
  </div>

  <div id="zones"></div>

  <hr class="my-4">

  <div class="d-flex justify-content-between align-items-center">
    <h5>คิวเปิดทีละจุด (Sequencer)</h5>
    <button class="btn btn-outline-danger btn-sm" onclick="clearQueue()">ล้างคิว</button>
  </div>
  <div class="row g-3 mt-1">
    <div class="col-md-4">
      <label class="form-label">ระยะเวลา/จุด (นาที)</label>
      <input id="q_minutes" type="number" min="1" value="30" class="form-control">
    </div>
    <div class="col-md-8 d-flex align-items-end gap-2">
      <button class="btn btn-primary" onclick="startQueue()">เริ่มรันคิว</button>
      <button class="btn btn-secondary" onclick="stopQueue()">หยุด</button>
      <div id="queueStatus" class="ms-2 small text-muted"></div>
    </div>
  </div>
  <div id="queue" class="mt-3"></div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== include app.js (ย่อ) ===== */
</script>
<script>
let timer = null;
let nowIndex = -1;

function renderZones(){
  const zones = LS.get("zones", []);
  const wrap = document.getElementById('zones');
  wrap.innerHTML = "";
  zones.forEach((z, zi)=>{
    const card = document.createElement('div');
    card.className = "card shadow-sm mb-3";
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">${z.name}</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" onclick='addPoint("${z.id}")'><i class="fa fa-plus"></i> จุดย่อย</button>
            <button class="btn btn-outline-secondary btn-sm" onclick='renameZone("${z.id}")'><i class="fa fa-pen"></i></button>
            <button class="btn btn-outline-danger btn-sm" onclick='delZone("${z.id}")'><i class="fa fa-trash"></i></button>
          </div>
        </div>
        <div class="row g-2">
          ${z.points.map(p => `
            <div class="col-6 col-md-3">
              <div class="border rounded p-2 h-100">
                <div class="d-flex justify-content-between align-items-center">
                  <strong>${p.name}</strong>
                  <span class="badge ${p.status==='on'?'bg-success':'bg-secondary'}">${p.status.toUpperCase()}</span>
                </div>
                <div class="mt-2 d-flex gap-2">
                  <button class="btn btn-sm ${p.status==='on'?'btn-outline-danger':'btn-outline-primary'}" onclick='togglePoint("${z.id}","${p.id}")'>
                    ${p.status==='on'?'ปิด':'เปิด'}
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" onclick='renamePoint("${z.id}","${p.id}")'><i class="fa fa-pen"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick='delPoint("${z.id}","${p.id}")'><i class="fa fa-trash"></i></button>
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" ${p.manual?'checked':''}
                    onchange='setManual("${z.id}","${p.id}", this.checked)'>
                  <label class="form-check-label small">ล็อกเป็นโหมดแมนนวล (ไม่ถูกรันโดยคิว)</label>
                </div>
                <button class="btn btn-sm btn-outline-success mt-2" onclick='addToQueue("${z.id}","${p.id}")'>
                  + เพิ่มในคิว
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>`;
    wrap.appendChild(card);
  });
  renderQueue();
}

function addZone(){
  const name = prompt("ชื่อโซน (เช่น โซน A)");
  if(!name) return;
  const zones = LS.get("zones", []);
  zones.push({id: uid("zone"), name, points:[]});
  LS.set("zones", zones);
  logEvent("zone.add", `เพิ่ม ${name}`);
  renderZones();
}
function renameZone(zid){
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  const name = prompt("ชื่อโซนใหม่", z?.name||"");
  if(!name) return;
  z.name = name;
  LS.set("zones", zones);
  renderZones();
}
function delZone(zid){
  if(!confirm("ลบโซนนี้และจุดย่อยทั้งหมด?")) return;
  let zones = LS.get("zones", []);
  zones = zones.filter(z=>z.id!==zid);
  LS.set("zones", zones);
  renderZones();
}

function addPoint(zid){
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  const name = prompt("ชื่อจุด (เช่น A1)");
  if(!name) return;
  z.points.push({id: uid("pt"), name, status:"off", manual:false});
  LS.set("zones", zones);
  renderZones();
}
function renamePoint(zid, pid){
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  const p = z.points.find(x=>x.id===pid);
  const name = prompt("ชื่อจุดใหม่", p?.name||"");
  if(!name) return;
  p.name = name;
  LS.set("zones", zones);
  renderZones();
}
function delPoint(zid, pid){
  if(!confirm("ลบจุดนี้?")) return;
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  z.points = z.points.filter(x=>x.id!==pid);
  LS.set("zones", zones);
  renderZones();
}
function setManual(zid, pid, manual){
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  const p = z.points.find(x=>x.id===pid);
  p.manual = manual;
  LS.set("zones", zones);
  renderZones();
}

function togglePoint(zid, pid, force){
  const zones = LS.get("zones", []);
  const z = zones.find(x=>x.id===zid);
  const p = z.points.find(x=>x.id===pid);
  p.status = force ? force : (p.status==='on'?'off':'on');
  LS.set("zones", zones);
  logEvent("water.toggle", `สั่ง${p.status==='on'?'เปิด':'ปิด'}น้ำ ${z.name}-${p.name}`);
  renderZones();
}

/* ---- Queue ---- */
function addToQueue(zid, pid){
  const q = LS.get("queue", []);
  q.push({zid, pid});
  LS.set("queue", q);
  renderQueue();
}
function renderQueue(){
  const q = LS.get("queue", []);
  const zones = LS.get("zones", []);
  const box = document.getElementById('queue');
  if(q.length===0){ box.innerHTML = `<div class="text-muted">ยังไม่มีคิว</div>`; return; }
  box.innerHTML = `
    <ol class="list-group list-group-numbered">
      ${q.map((it,i)=>{
        const z = zones.find(z=>z.id===it.zid); const p = z?.points.find(x=>x.id===it.pid);
        return `<li class="list-group-item d-flex justify-content-between align-items-center">
          ${z?.name||"?"} - ${p?.name||"?"}
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" onclick="moveQ(${i},-1)">▲</button>
            <button class="btn btn-outline-secondary" onclick="moveQ(${i},1)">▼</button>
            <button class="btn btn-outline-danger" onclick="rmQ(${i})"><i class="fa fa-trash"></i></button>
          </div>
        </li>`;
      }).join('')}
    </ol>
  `;
}
function moveQ(i,dir){
  const q = LS.get("queue", []);
  const j = i+dir; if(j<0||j>=q.length) return;
  [q[i], q[j]] = [q[j], q[i]];
  LS.set("queue", q); renderQueue();
}
function rmQ(i){
  const q = LS.get("queue", []);
  q.splice(i,1); LS.set("queue", q); renderQueue();
}
function clearQueue(){ LS.set("queue", []); renderQueue(); }

function startQueue(){
  stopQueue();
  const minutes = Math.max(1, num(document.getElementById('q_minutes').value));
  const ms = minutes*60*1000;
  const q = LS.get("queue", []);
  const zones = LS.get("zones", []);

  nowIndex = -1;
  const tick = ()=>{
    nowIndex++;
    if(nowIndex>0){
      // ปิดจุดก่อนหน้า
      const prev = q[nowIndex-1]; if(prev){
        togglePoint(prev.zid, prev.pid, "off");
      }
    }
    const cur = q[nowIndex];
    if(!cur){ stopQueue(); document.getElementById('queueStatus').innerText = "คิวเสร็จสิ้น"; return; }

    // ข้ามจุดที่ถูกล็อก manual
    const z = zones.find(z=>z.id===cur.zid);
    const p = z?.points.find(x=>x.id===cur.pid);
    if(p?.manual){ tick(); return; }

    togglePoint(cur.zid, cur.pid, "on");
    document.getElementById('queueStatus').innerText = `กำลังรันลำดับ ${nowIndex+1}/${q.length} (เปิด ${z?.name}-${p?.name})`;
    timer = setTimeout(tick, ms);
  };
  logEvent("queue.start", `เริ่มรันคิวรดน้ำ ระยะต่อจุด ${minutes} นาที`);
  tick();
}
function stopQueue(){
  if(timer){ clearTimeout(timer); timer=null; }
  document.getElementById('queueStatus').innerText = "หยุดแล้ว";
}
</script>
</body>
</html>
